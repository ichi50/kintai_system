{% extends "attendance/app_base.html" %}
{% load static %}
{% load calendar_tags %}
{% block title %}打刻メイン画面{% endblock %}
{% block header_title %}シフト管理アプリ{% endblock %}

{% block content %}
<div class="d-flex flex-column align-items-center mt-4">
    <div style="max-width: 450px; width: 100%;">
        <h4 class="text-center mb-4">ようこそ、{{ user.username }}さん</h4>
        <div class="card shadow-sm mb-5">
            <div class="card-header bg-light text-center">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <a href="{% url 'kintai:index' %}?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-sm btn-outline-primary">&lt; 前月</a>
                    <h5 class="mb-0">{{ current_month_str }} のシフト</h5>
                    <a href="{% url 'kintai:index' %}?year={{ next_year }}&month={{ next_month }}" class="btn btn-sm btn-outline-primary">次月 &gt;</a>
                </div>
            </div>
            <div class="card-body p-2">
                {% get_shift_calendar user year month as calendar_html %}
                {{ calendar_html|safe }}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shiftDetailModal" tabindex="-1" aria-labelledby="shiftDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="shiftDetailModalLabel">シフト詳細</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>日付:</strong> <span id="modalShiftDate"></span></p>
                <p><strong>勤務時間:</strong> <span id="modalShiftTime"></span></p> 
                
                <div id="modalNoShift" class="alert alert-warning d-none">
                    この日はシフトが登録されていません。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

{% endblock %} 

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendar = document.querySelector('.calendar');
    const shiftDetailModal = new bootstrap.Modal(document.getElementById('shiftDetailModal'));

    if (calendar) {
        calendar.addEventListener('click', function(e) {
            let targetCell = e.target.closest('.clickable-cell');
            if (targetCell) {
                const shiftDataRaw = targetCell.dataset.shiftDetail;
                
                // モーダルのDOM要素を取得 (modalShiftNameは削除)
                const modalDate = document.getElementById('modalShiftDate');
                const modalShiftTime = document.getElementById('modalShiftTime');
                const modalNoShift = document.getElementById('modalNoShift');

                // 常に日付は表示
                modalDate.textContent = targetCell.dataset.date;
                
                // 勤務時間要素の親段落を取得 (シフトがないときに非表示にするため)
                const timeParagraph = modalShiftTime.closest('p');
                
                // 勤務時間の要素をデフォルトで非表示にしておく
                if (timeParagraph) timeParagraph.classList.add('d-none');

                if (shiftDataRaw && shiftDataRaw !== '{}') {
                    // シフト情報がある場合
                    try {
                        // HTMLエンティティとして格納されたJSONをパース
                        const shiftData = JSON.parse(shiftDataRaw.replace(/&quot;/g, '"'));

                        modalShiftTime.textContent = shiftData.time_str;
                        
                        // シフトなしメッセージを非表示、情報を表示
                        modalNoShift.classList.add('d-none');
                        // 勤務時間の表示
                        if (timeParagraph) timeParagraph.classList.remove('d-none'); 
                        
                    } catch (e) {
                        console.error("Failed to parse shift data:", e);
                        // データパースエラーの場合
                        modalShiftTime.textContent = 'エラー';
                        modalNoShift.classList.remove('d-none');
                    }
                } else {
                    // シフト情報がない場合
                    modalShiftTime.textContent = '―';
                    
                    // シフトなしメッセージを表示
                    modalNoShift.classList.remove('d-none');
                    // 勤務時間の段落は d-none のまま
                }               
                // モーダルを表示
                shiftDetailModal.show();
            }
        });
    }
});
</script>{% endblock %}

{% block extra_css %}
<style>
.calendar {
    table-layout: fixed !important; /* セル幅を均等に固定 */
    width: 100% !important; 
}
/* カレンダーの基本スタイル調整 */
.calendar th, .calendar td {
    padding: 2px !important; /* パディングをわずかに増やして安定化 */
    height: 70px !important; 
    vertical-align: top !important;
    cursor: pointer;
    position: relative; 
    width: calc(100% / 7) !important; 
    box-sizing: border-box !important;
}

.calendar td:hover {
    background-color: aqua;
}

.calendar-day .day-num {
    text-align: right;
    padding-right: 2px; 
    font-size: 0.8em !important; /* フォントサイズを小さくしてスペース確保 */
    font-weight: bold;
}
.calendar-day .shift-info {
    text-align: center;
    font-size: 0.7em !important; /* 日付よりもさらに小さく */
    line-height: 1.2 !important;     
    white-space: normal; 
    overflow: visible !important; 
    text-overflow: clip; 
    margin-top: 2px;
}
.clickable-cell.selected {
    background-color: #e0f7fa !important; /* 選択時の色 */
    border: 2px solid #00bcd4 !important;
}

/* ポップアップのスタイル */
.detail-popup {
    /* セル内に配置されるため、セルに合わせて位置を調整 */
    top: 0;
    left: 100%;
    transform: translateX(-50%);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}