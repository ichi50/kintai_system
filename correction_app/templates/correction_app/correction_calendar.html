{% extends "attendance/app_base.html" %}
{% load static %}

{% block title %}å‹¤æ€ ä¿®æ­£{% endblock %}
{% block header_title %}ã‚·ãƒ•ãƒˆç®¡ç†ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}

<div class="container my-5">
    <h4 class="text-center mb-4">å‹¤æ€ ã®ä¿®æ­£</h4>
    <div class="card shadow-sm mb-5">
        <div class="alert alert-primary text-center shadow-sm mb-4" role="alert">
            æ—¥ä»˜ã‚’é¸æŠã—ã¦å‹¤æ€ ã®ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„
        </div>
        <div class="card-header bg-light text-center">
            <h2 class="text-center mb-4">
                <a href="{% url 'correction:calendar_month' prev_month|slice:":4" prev_month|slice:"5:" %}" class="btn btn-sm btn-outline-secondary">&lt; å‰æœˆ</a>
                {{ current_month_name }}
                <a href="{% url 'correction:calendar_month' next_month|slice:":4" next_month|slice:"5:" %}" class="btn btn-sm btn-outline-secondary">ç¿Œæœˆ &gt;</a>
            </h2>

        {# ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ #}
            <div class="table-responsive">
                <table class="table table-bordered text-center calendar">
                    <thead>
                        <tr>
                            <th class="text-danger">æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th>
                            <th class="text-primary">åœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar_data %}
                        <tr>
                            {% for day in week %}
                            {% with attendance=day.attendance %}
                            <td class="{% if not day.is_current_month %}table-secondary{% endif %}
                                    {% if day.is_today %}today-highlight{% endif %}
                                    {% if attendance and attendance.is_punched %}clickable-cell{% endif %}"
                                data-date="{{ day.date_str }}"
                                data-attendance-data="{{ attendance|default_if_none:'{}'|escape }}"
                                {% if attendance and attendance.is_punched %}
                                data-bs-toggle="modal" 
                                data-bs-target="#correctionModal"
                                {% endif %}
                            >
                                {# æ—¥ä»˜è¡¨ç¤º #}
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="day-number {% if forloop.first %}text-danger{% elif forloop.last %}text-primary{% endif %}">
                                        {{ day.date.day }}
                                    </span>
                                </div>

                                {# ğŸš¨ ä¿®æ­£: å‹¤å‹™æ™‚é–“å¸¯ã®è¡¨ç¤º #}
                                {% if attendance and attendance.is_punched %}
                                <div class="work-summary small mt-1 text-primary">
                                    {{ attendance.start_time }} ã€œ {{ attendance.end_time }}
                                </div>
                                {# å®Ÿç¸¾ã¯ã‚ã‚‹ãŒã€å‡ºé€€å‹¤ãŒæƒã£ã¦ã„ãªã„å ´åˆãªã©ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰ #}
                                {% elif attendance %}
                                <div class="work-summary small mt-1 text-muted">
                                    æ‰“åˆ»ãªã—
                                </div>
                                {% endif %}
                            </td>
                            {% endwith %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# å‹¤æ€ ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®ä¸‹ã«å®šç¾©ï¼‰ #}
{% include 'correction_app/correction_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendar = document.querySelector('.calendar');
    const correctionModal = new bootstrap.Modal(document.getElementById('correctionModal'));
    const punchItemsContainer = document.getElementById('punchItemsContainer');
    const addPunchItemButton = document.getElementById('addPunchItem');
    const correctionForm = document.getElementById('correctionForm');

    // æ‰“åˆ»å†…å®¹ã®é¸æŠè‚¢ (Pythonã®CHOICESã¨åˆã‚ã›ã‚‹)
    const punchChoices = [
        {value: 'start', text: 'å‡ºå‹¤'},
        {value: 'end', text: 'é€€å‹¤'},
        {value: 'break_start', text: 'ä¼‘æ†©é–‹å§‹'},
        {value: 'break_end', text: 'ä¼‘æ†©çµ‚äº†'},
    ];

    let itemCounter = 0; // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªnameã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

    // ------------------------------------------
    // 1. æ‰“åˆ»é …ç›®ã®HTMLã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // ------------------------------------------
    function createPunchItemHtml(punchTime = '', punchType = '') {
        const index = itemCounter++;
        let optionsHtml = punchChoices.map(choice => 
            `<option value="${choice.value}" ${punchType === choice.value ? 'selected' : ''}>${choice.text}</option>`
        ).join('');
        
        // ç¾åœ¨æ™‚åˆ»ï¼ˆHH:MMï¼‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        const defaultTime = punchTime || new Date().toTimeString().slice(0, 5);

        return `
        <div class="row g-3 align-items-center mb-3 punch-item" data-index="${index}">
            <div class="col-md-5">
                <label class="form-label visually-hidden">æ‰“åˆ»æ™‚é–“</label>
                <input type="time" class="form-control" name="punch_time_${index}" value="${defaultTime}" required>
            </div>
            <div class="col-md-5">
                <label class="form-label visually-hidden">æ‰“åˆ»å†…å®¹</label>
                <select class="form-select" name="punch_type_${index}" required>
                    <option value="" disabled ${!punchType ? 'selected' : ''}>é¸æŠã—ã¦ãã ã•ã„</option>
                    ${optionsHtml}
                </select>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-danger btn-sm remove-punch-item">
                    å‰Šé™¤
                </button>
            </div>
        </div>
        `;
    }
    
    // ------------------------------------------
    // 2. æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
    // ------------------------------------------
    if (calendar) {
        calendar.addEventListener('click', function(e) {
            let targetCell = e.target.closest('.clickable-cell');

            if (targetCell) {
                const dateString = targetCell.dataset.date;
                // const attendanceData = JSON.parse(targetCell.dataset.attendanceData.replace(/&quot;/g, '"'));
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åˆæœŸåŒ–
                punchItemsContainer.innerHTML = '';
                document.getElementById('correctionReason').value = '';
                itemCounter = 0; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ

                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’è¨­å®š
                const headerDateElement = document.getElementById('modalHeaderDate');
                const dateObj = new Date(dateString);
                headerDateElement.textContent = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã® hidden input ã«æ—¥ä»˜ã‚’è¨­å®š
                document.getElementById('modalAttendanceDate').value = dateString;
                
                // åˆæœŸé …ç›®ã‚’2ã¤ï¼ˆå‡ºå‹¤ã¨é€€å‹¤ã‚’æƒ³å®šï¼‰è¿½åŠ 
                punchItemsContainer.insertAdjacentHTML('beforeend', createPunchItemHtml());
                punchItemsContainer.insertAdjacentHTML('beforeend', createPunchItemHtml());

                correctionModal.show();
            }
        });
    }

    // ------------------------------------------
    // 3. é …ç›®è¿½åŠ /å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯
    // ------------------------------------------
    addPunchItemButton.addEventListener('click', function() {
        punchItemsContainer.insertAdjacentHTML('beforeend', createPunchItemHtml());
    });

    punchItemsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-punch-item')) {
            const itemToRemove = e.target.closest('.punch-item');
            if (itemToRemove) {
                itemToRemove.remove();
            }
        }
    });

    // ------------------------------------------
    // 4. ç”³è«‹ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼‰
    // ------------------------------------------
    correctionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const correctionData = {
            attendance_date: formData.get('attendance_date'),
            reason: formData.get('reason'),
            correction_times: []
        };
        
        // æ‰“åˆ»é …ç›®ã‚’åé›†
        const punchItems = punchItemsContainer.querySelectorAll('.punch-item');
        punchItems.forEach((item, index) => {
            const punchTimeInput = item.querySelector('input[type="time"]');
            const punchTypeSelect = item.querySelector('select');
            
            // æ—¥ä»˜ã¨æ™‚é–“ã‚’çµåˆã—ã¦DateTimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ç”¨)
            const fullDateTime = `${correctionData.attendance_date}T${punchTimeInput.value}:00`;

            correctionData.correction_times.push({
                sequence: index,
                punch_time: fullDateTime,
                punch_type: punchTypeSelect.value
            });
        });

        if (correctionData.correction_times.length === 0) {
            alert('æ‰“åˆ»é …ç›®ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // ğŸš¨ ä¿®æ­£ç”³è«‹ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ï¼ˆFetch APIã‚’ä½¿ç”¨ï¼‰
        fetch("{% url 'correction:submit' %}", { // URLã¯å¾Œã§ãƒ“ãƒ¥ãƒ¼ä½œæˆæ™‚ã«ä¿®æ­£
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: JSON.stringify(correctionData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ç”³è«‹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            return response.json();
        })
        .then(data => {
            alert('å‹¤æ€ ä¿®æ­£ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            correctionModal.hide(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ã™ã‚‹
            window.location.reload(); 
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ç”³è«‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
    });
    
    // ğŸš¨ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è­¦å‘Šã®å†ç™ºé˜²æ­¢ã®ãŸã‚ã€ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜æ™‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
    const modalElement = document.getElementById('correctionModal');
    if (modalElement) {
        modalElement.addEventListener('hidden.bs.modal', function () {
            document.body.focus();
        });
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* å‹¤æ€ ä¿®æ­£ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ã‚’æ®‹ã™ */
.calendar {
    table-layout: fixed !important; 
    width: 100% !important; 
}

.calendar th, .calendar td {
    padding: 2px !important; 
    height: 70px !important; 
    vertical-align: top !important;
    cursor: default; /* clickable-cellã§ã®ã¿ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´ */
    position: relative; 
    width: calc(100% / 7) !important; 
    box-sizing: border-box !important;
}

/* ğŸš¨ é‡è¦ãªä¿®æ­£: ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚»ãƒ«ã§ã®ã¿ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´ */
.calendar td.clickable-cell {
    cursor: pointer; 
    background-color: #f7f7f7; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã“ã¨ã‚’è¦–è¦šçš„ã«ç¤ºã™ */
}

.calendar td .day-number {
    text-align: right;
    padding-right: 2px; 
    font-size: 0.9em !important;
    font-weight: bold;
}

.day-num {
    float: right;
    font-weight: bold;
    font-size: 1.1em;
}

.calendar td .work-summary {
    text-align: center;
    font-size: 0.7em !important; 
    line-height: 1.2 !important;     
    white-space: normal; 
    overflow: visible !important; 
    text-overflow: clip; 
    margin-top: 2px;
}

.calendar td.today-highlight {
    border: 3px solid #ffc107 !important;
    border-radius: 5px;
    box-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
    z-index: 10;
}
/* ğŸš¨ ã‚·ãƒ•ãƒˆç”³è«‹ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸ */
</style>
{% endblock %}